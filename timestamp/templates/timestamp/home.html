<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0"
    >
    <title>P&amp;P Logger</title>

    <!-- Select2 CSS -->
    <link
        href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
        rel="stylesheet"
    >

    <style>
        /* Base layout */
        body {
            font-family: sans-serif;
            text-align: center;
            margin: 0;
            padding: 10px;

            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Buttons */
        .btn-group button {
            font-size: 1.5rem;
            padding: 15px 30px;
            margin: 5px;

            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
        }

        .pee {
            background: #ffeb3b;
        }

        .pill {
            background: #4caf50;
            color: white;
        }

        /* Log entries */
        .log-entry-container {
            width: 100%;
            max-width: 400px;
        }

        .log-entry-container button {
            font-size: 0.7rem;
            padding: 1px 3px;
            margin-left: 5px;

            border-radius: 3px;
            background: #f44336;
            color: white;
        }
    </style>
</head>

<body>

    <h2>Pee &amp; Pill Logger</h2>

    <!-- Main buttons -->
    <div class="btn-group">
        <button
            class="pee"
            onclick="log('pee')"
        >
            Pee
        </button>

        <button
            id="pee-at-time-btn"
            class="pee"
            onclick="
                document.getElementById('pee-time-form-container').style.display = 'block';
                this.style.display = 'none';
            "
        >
            Pee at Time
        </button>

        <button
            id="poo-at-time-btn"
            style="background:#8d6e63;color:white;"
            onclick="
                document.getElementById('poo-time-form-container').style.display = 'block';
                this.style.display = 'none';
            "
        >
            Poo at Time
        </button>

        <button
            id="pee-with-volume-btn"
            class="pee"
            onclick="
                document.getElementById('pee-form-container').style.display = 'block';
                this.style.display = 'none';
            "
        >
            Pee with Volume
        </button>
        

        <button
            class="pill"
            onclick="log('pill')"
        >
            Pill
        </button>

        <button
            id="pill-with-note-btn"
            class="pill"
            onclick="
                document.getElementById('pill-form-container').style.display = 'block';
                this.style.display = 'none';
            "
        >
            Pill with Note
        </button>
    </div>

    <div
        id="pee-time-form-container"
        style="
            display: none;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 300px;
        "
    >
        <h3>Log Pee at Specific Time</h3>
    
        <input
            type="datetime-local"
            id="pee-time-input"
            style="width: 100%; padding: 5px; margin-bottom: 10px;"
        >
    
        <button
            class="pee"
            onclick="logPeeAtTime()"
        >
            Log Pee
        </button>
    
        <button
            type="button"
            onclick="
                document.getElementById('pee-time-form-container').style.display = 'none';
                document.getElementById('pee-at-time-btn').style.display = 'inline-block';
                document.getElementById('pee-time-input').value = '';
            "
        >
            Cancel
        </button>
    </div>
    
    <div
        id="poo-time-form-container"
        style="
            display: none;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 300px;
        "
    >
        <h3>Log Poo at Specific Time</h3>
    
        <input
            type="datetime-local"
            id="poo-time-input"
            style="width: 100%; padding: 5px; margin-bottom: 10px;"
        >
    
        <button
            style="background:#8d6e63;color:white;"
            onclick="logPooAtTime()"
        >
            Log Poo
        </button>
    
        <button
            type="button"
            onclick="
                document.getElementById('poo-time-form-container').style.display = 'none';
                document.getElementById('poo-at-time-btn').style.display = 'inline-block';
                document.getElementById('poo-time-input').value = '';
            "
        >
            Cancel
        </button>
    </div>
    

    <div
        id="pee-form-container"
        style="
            display: none;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 300px;
        "
    >
        <h3>Log Pee with Volume (ml)</h3>

        <input
            type="number"
            id="volume-input"
            placeholder="Volume (ml)"
            style="width: 100%; padding: 5px; margin-bottom: 10px;"
            min="1"
        >

        <button
            class="pee"
            style="margin-top: 10px;"
            onclick="logPeeWithVolume()"
        >
            Log Pee
        </button>

        <button
            type="button"
            onclick="
                document.getElementById('pee-form-container').style.display = 'none';
                document.getElementById('pee-with-volume-btn').style.display = 'inline-block';
                document.getElementById('volume-input').value = ''; /* Clear input on cancel */
            "
        >
            Cancel
        </button>
    </div>
    <!-- Pill with note form -->
    <div
        id="pill-form-container"
        style="
            display: none;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 300px;
        "
    >
        <h3>Log Pill with Note</h3>

        <select
            id="note-selector"
            style="width: 100%;"
        >
            {# Options loaded dynamically by Select2 #}
        </select>

        <button
            class="pill"
            style="margin-top: 10px;"
            onclick="logPillWithNote()"
        >
            Log Pill
        </button>

        <button
            type="button"
            onclick="
                document.getElementById('pill-form-container').style.display = 'none';
                document.getElementById('pill-with-note-btn').style.display = 'inline-block';
            "
        >
            Cancel
        </button>
    </div>

    <!-- Daily counts -->
    <div
        style="
            margin: 10px 0;
            font-size: 1rem;
        "
    >
        <strong>Daily Counts:</strong><br>

        <div id="count-container">
            {% include "timestamp/count_partial.html" %}
        </div>
    </div>

    <!-- Log list -->
    <div
        id="log-container"
        class="log-entry-container"
    >
        {% include "timestamp/log_partial.html" %}
    </div>

    <!-- JS dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        /* --- URL CONSTANTS --- */
        const LOG_CREATE_URL = "{% url 'log_create' %}";
        const LOG_DELETE_URL = "{% url 'log_delete' %}";

        const LOG_LIST_PARTIAL_URL =
            "{% url 'log_list' %}?partial=logs";

        const COUNT_LIST_PARTIAL_URL =
            "{% url 'log_list' %}?partial=counts";

        const NOTE_AUTOCOMPLETE_URL =
            "{% url 'note_autocomplete_json' %}";

        /* --- SELECT2 INITIALIZATION --- */
        $('#note-selector').select2({
            placeholder: "Select or type a new note...",
            allowClear: true,
            tags: true,
            ajax: {
                url: NOTE_AUTOCOMPLETE_URL,
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    return {
                        results: data.map(item => ({
                            id: item.id,
                            text: item.text
                        }))
                    };
                }
            },
            createTag: function (params) {
                return {
                    id: params.term,
                    text: params.term,
                    newTag: true   // KEY FLAG
                };
            }
        });

        /* --- UPDATE FUNCTIONS --- */
        async function updateCounts() {
            const resp = await fetch(COUNT_LIST_PARTIAL_URL);
            document.getElementById('count-container').innerHTML =
                await resp.text();
        }

        async function updateLogList() {
            const resp = await fetch(LOG_LIST_PARTIAL_URL);
            document.getElementById('log-container').innerHTML =
                await resp.text();
        }

        /* --- CORE LOGGING --- */
        async function log(action) {
            const btn = event.target;
            btn.disabled = true;
            btn.style.opacity = 0.6;

            await fetch(LOG_CREATE_URL, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({ action })
            });

            await updateLogList();
            await updateCounts();

            btn.disabled = false;
            btn.style.opacity = 1;
        }

        async function logPeeAtTime() {
            const ts = document.getElementById('pee-time-input').value;
        
            if (!ts) {
                alert('Please select a date and time.');
                return;
            }
        
            await fetch(LOG_CREATE_URL, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    action: 'pee',
                    timestamp: ts
                })
            });
        
            await updateLogList();
            await updateCounts();
        
            document.getElementById('pee-time-input').value = '';
            document.getElementById('pee-time-form-container').style.display = 'none';
            document.getElementById('pee-at-time-btn').style.display = 'inline-block';
        }
        
        async function logPooAtTime() {
            const ts = document.getElementById('poo-time-input').value;
        
            if (!ts) {
                alert('Please select a date and time.');
                return;
            }
        
            await fetch(LOG_CREATE_URL, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    action: 'poo',
                    timestamp: ts
                })
            });
        
            await updateLogList();
            await updateCounts();
        
            document.getElementById('poo-time-input').value = '';
            document.getElementById('poo-time-form-container').style.display = 'none';
            document.getElementById('poo-at-time-btn').style.display = 'inline-block';
        }
        

        /* --- PEE WITH VOLUME --- */
        async function logPeeWithVolume() {
            const volume = document.getElementById('volume-input').value;

            if (!volume || isNaN(parseInt(volume)) || parseInt(volume) <= 0) {
                alert('Please enter a valid volume (e.g., a positive number).');
                return;
            }

            await fetch(LOG_CREATE_URL, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    action: 'pee',
                    volume: volume
                })
            });

            await updateLogList();
            await updateCounts();

            document.getElementById('volume-input').value = '';
            document.getElementById('pee-form-container').style.display = 'none';
            document.getElementById('pee-with-volume-btn').style.display = 'inline-block';
        }
        /* --- PILL WITH NOTE --- */
        async function logPillWithNote() {
            const data = $('#note-selector').select2('data')[0];
        
            if (!data) {
                alert('Please select or enter a note.');
                return;
            }
        
            const payload = { action: 'pill' };
        
            if (data.newTag) {
                payload.note_text = data.text;  // NEW NOTE
            } else {
                payload.note_id = data.id;       // EXISTING NOTE
            }
        
            await fetch(LOG_CREATE_URL, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams(payload)
            });
        
            await updateLogList();
            await updateCounts();
        
            $('#note-selector').val(null).trigger('change');
            document.getElementById('pill-form-container').style.display = 'none';
            document.getElementById('pill-with-note-btn').style.display = 'inline-block';
        }

        /* --- DELETE --- */
        async function removeLog(logId) {
            if (!confirm('Delete?')) {
                return;
            }

            await fetch(LOG_DELETE_URL, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({ id: logId })
            });

            await updateLogList();
            await updateCounts();
        }
    </script>

</body>
</html>
