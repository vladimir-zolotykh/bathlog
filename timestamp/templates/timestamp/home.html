<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0"
    >
    <title>P&amp;P Logger</title>

    <!-- Select2 CSS -->
    <link
        href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
        rel="stylesheet"
    >

    <style>
        /* Base layout */
        body {
            font-family: sans-serif;
            text-align: center;
            margin: 0;
            padding: 10px;

            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Buttons */
        .btn-group button {
            font-size: 1.5rem;
            padding: 15px 30px;
            margin: 5px;

            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
        }

        .pee {
            background: #ffeb3b;
        }

        .pill {
            background: #4caf50;
            color: white;
        }

        /* Log entries */
        .log-entry-container {
            width: 100%;
            max-width: 400px;
        }

        .log-entry-container button {
            font-size: 0.7rem;
            padding: 1px 3px;
            margin-left: 5px;

            border-radius: 3px;
            background: #f44336;
            color: white;
        }
    </style>
</head>

<body>

    <h2>Pee &amp; Pill Logger</h2>

    <!-- Main buttons -->
    <div class="btn-group">
        <button
            class="pee"
            onclick="log('pee')"
        >
            Pee
        </button>

        <button
            class="pill"
            onclick="log('pill')"
        >
            Pill
        </button>

        <button
            id="pill-with-note-btn"
            class="pill"
            onclick="
                document.getElementById('pill-form-container').style.display = 'block';
                this.style.display = 'none';
            "
        >
            Pill with Note
        </button>
    </div>

    <!-- Pill with note form -->
    <div
        id="pill-form-container"
        style="
            display: none;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 300px;
        "
    >
        <h3>Log Pill with Note</h3>

        <select
            id="note-selector"
            style="width: 100%;"
        >
            {# Options loaded dynamically by Select2 #}
        </select>

        <button
            class="pill"
            style="margin-top: 10px;"
            onclick="logPillWithNote()"
        >
            Log Pill
        </button>

        <button
            type="button"
            onclick="
                document.getElementById('pill-form-container').style.display = 'none';
                document.getElementById('pill-with-note-btn').style.display = 'inline-block';
            "
        >
            Cancel
        </button>
    </div>

    <!-- Daily counts -->
    <div
        style="
            margin: 10px 0;
            font-size: 1rem;
        "
    >
        <strong>Daily Counts:</strong><br>

        <div id="count-container">
            {% include "timestamp/count_partial.html" %}
        </div>
    </div>

    <!-- Log list -->
    <div
        id="log-container"
        class="log-entry-container"
    >
        {% include "timestamp/log_partial.html" %}
    </div>

    <!-- JS dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        /* --- URL CONSTANTS --- */
        const LOG_CREATE_URL = "{% url 'log_create' %}";
        const LOG_DELETE_URL = "{% url 'log_delete' %}";

        const LOG_LIST_PARTIAL_URL =
            "{% url 'log_list' %}?partial=logs";

        const COUNT_LIST_PARTIAL_URL =
            "{% url 'log_list' %}?partial=counts";

        const NOTE_AUTOCOMPLETE_URL =
            "{% url 'note_autocomplete_json' %}";

        /* --- SELECT2 INITIALIZATION --- */
        $(document).ready(function () {
            $('#note-selector').select2({
                placeholder: "Select or search for a note...",
                allowClear: true,
                tags: true,
                ajax: {
                    url: NOTE_AUTOCOMPLETE_URL,
                    dataType: 'json',
                    delay: 250,
                    processResults: function (data) {
                        return {
                            results: data.map(item => ({
                                id: item.id,
                                text: item.text
                            }))
                        };
                    },
                    cache: true
                }
            });
        });

        /* --- UPDATE FUNCTIONS --- */
        async function updateCounts() {
            const resp = await fetch(COUNT_LIST_PARTIAL_URL);
            document.getElementById('count-container').innerHTML =
                await resp.text();
        }

        async function updateLogList() {
            const resp = await fetch(LOG_LIST_PARTIAL_URL);
            document.getElementById('log-container').innerHTML =
                await resp.text();
        }

        /* --- CORE LOGGING --- */
        async function log(action) {
            const btn = event.target;
            btn.disabled = true;
            btn.style.opacity = 0.6;

            await fetch(LOG_CREATE_URL, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({ action })
            });

            await updateLogList();
            await updateCounts();

            btn.disabled = false;
            btn.style.opacity = 1;
        }

        /* --- PILL WITH NOTE --- */
        async function logPillWithNote() {
            const noteId = $('#note-selector').val();

            if (!noteId) {
                alert('Please select a note.');
                return;
            }

            await fetch(LOG_CREATE_URL, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    action: 'pill',
                    note_id: noteId
                })
            });

            await updateLogList();
            await updateCounts();

            $('#note-selector').val(null).trigger('change');
            document.getElementById('pill-form-container').style.display = 'none';
            document.getElementById('pill-with-note-btn').style.display = 'inline-block';
        }

        /* --- DELETE --- */
        async function removeLog(logId) {
            if (!confirm('Delete?')) {
                return;
            }

            await fetch(LOG_DELETE_URL, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({ id: logId })
            });

            await updateLogList();
            await updateCounts();
        }
    </script>

</body>
</html>
